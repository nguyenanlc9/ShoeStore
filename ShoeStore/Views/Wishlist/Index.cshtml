@model IEnumerable<ShoeStore.Models.Wishlist>
@using ShoeStore.Models.Enums
@{
    ViewData["Title"] = "Danh sách yêu thích";
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Danh sách yêu thích</h2>
            @if (!Model.Any())
            {
                <div class="alert alert-info">
                    Danh sách yêu thích của bạn đang trống.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Giá</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="@item.Product.ImagePath" alt="@item.Product.Name" style="width: 100px; height: 100px; object-fit: cover;" class="me-3">
                                            <div>
                                                <h5>@item.Product.Name</h5>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (item.Product.DiscountPrice > 0)
                                        {
                                            <div>
                                                <span class="text-decoration-line-through text-muted">@item.Product.Price.ToString("N0") đ</span>
                                                <br />
                                                <span class="text-danger">@item.Product.DiscountPrice.ToString("N0") đ</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span>@item.Product.Price.ToString("N0") đ</span>
                                        }
                                    </td>
                                    <td>
                                        @switch (item.Status)
                                        {
                                            case WishlistStatus.InStock:
                                                <span class="badge bg-success">Đang bán</span>
                                                break;
                                            case WishlistStatus.OutOfStock:
                                                <span class="badge bg-warning text-dark">Hết hàng</span>
                                                break;
                                            case WishlistStatus.Discontinued:
                                                <span class="badge bg-danger">Ngưng kinh doanh</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="@Url.Action("Detail", "Shop", new { id = item.ProductId })" class="btn btn-primary btn-sm">
                                                <i class="fas fa-eye"></i> Xem
                                            </a>
                                            @if (item.Status == WishlistStatus.InStock)
                                            {
                                                <a href="@Url.Action("Detail", "Shop", new { id = item.ProductId })" class="btn btn-success btn-sm">
                                                    <i class="fas fa-shopping-cart"></i> Mua ngay
                                                </a>
                                            }
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeFromWishlist(@item.WishlistId)">
                                                <i class="fas fa-trash"></i> Xóa
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function removeFromWishlist(wishlistId) {
            if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi danh sách yêu thích?')) {
                $.ajax({
                    url: '/Wishlist/RemoveById',
                    type: 'POST',
                    data: { wishlistId: wishlistId },
                    success: function(result) {
                        if (result.success) {
                            // Xóa dòng khỏi bảng
                            $(`tr:has(button[onclick="removeFromWishlist(${wishlistId})"])`).fadeOut(300, function() {
                                $(this).remove();
                                // Kiểm tra nếu không còn sản phẩm nào
                                if ($('tbody tr').length === 0) {
                                    $('.table-responsive').replaceWith(
                                        '<div class="alert alert-info">Danh sách yêu thích của bạn đang trống.</div>'
                                    );
                                }
                            });
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function() {
                        alert('Có lỗi xảy ra khi xóa sản phẩm khỏi danh sách yêu thích');
                    }
                });
            }
        }
    </script>
}